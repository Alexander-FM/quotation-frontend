<div class="p-4">
  <p-toast />
  <p-confirmDialog />

  <div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Gestión de Cotizaciones</h2>
      <p-button label="Nueva Cotización" icon="pi pi-plus" (onClick)="openNew()" severity="success" />
    </div>

    <p-table [value]="quotations" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,25,50]" [loading]="loading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} cotizaciones" dataKey="id"
      [expandedRowKeys]="expandedRows" [tableStyle]="{ 'min-width': '75rem' }">

      <ng-template #header>
        <tr>
          <th style="width: 5%"></th>
          <th pSortableColumn="id" style="width: 5%">ID <p-sortIcon field="id" /></th>
          <th pSortableColumn="customerName" style="width: 15%">Cliente <p-sortIcon field="customerName" /></th>
          <th pSortableColumn="employeeName" style="width: 15%">Vendedor <p-sortIcon field="employeeName" /></th>
          <th pSortableColumn="state" style="width: 12%">Estado <p-sortIcon field="state" /></th>
          <th pSortableColumn="totalProductionCost" style="width: 15%">Total <p-sortIcon field="totalProductionCost" />
          </th>
          <th style="width: 12%">Acciones</th>
        </tr>
      </ng-template>

      <ng-template #body let-quot let-expanded="expanded">
        <tr>
          <td>
            <p-button type="button" [pRowToggler]="quot" [text]="true" [rounded]="true" [plain]="true"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
          </td>
          <td>{{ quot.id }}</td>
          <td>{{ quot.customerName }}</td>
          <td>{{ quot.employeeName }}</td>
          <td>
            <p-tag [value]="quot.state" [severity]="getStateSeverity(quot.state)" />
          </td>
          <td>{{ quot.totalProductionCost | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>
            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editQuotation(quot)"
              class="mr-2" />
            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
              (onClick)="deleteQuotation(quot)" />
          </td>
        </tr>
      </ng-template>

      <ng-template #expandedrow let-quot>
        <tr>
          <td colspan="7">
            <div class="p-3">
              <h5>Módulos Cotizados</h5>
              <p-table [value]="quot.details" dataKey="id" [expandedRowKeys]="expandedDetailsRows">
                <ng-template #header>
        <tr>
          <th style="width: 3%"></th>
          <th pSortableColumn="module.name" style="width: 12%">Módulo <p-sortIcon field="module.name" /></th>
          <th pSortableColumn="quantity" style="width: 6%">Cant. <p-sortIcon field="quantity" /></th>
          <th pSortableColumn="transportationCost" style="width: 8%">Transporte <p-sortIcon
              field="transportationCost" /></th>
          <th pSortableColumn="laborCost" style="width: 8%">M. Obra <p-sortIcon field="laborCost" /></th>
          <th pSortableColumn="packingCost" style="width: 8%">Empaque <p-sortIcon field="packingCost" /></th>
          <th pSortableColumn="overheadsAmount" style="width: 9%">Gastos Gral. <p-sortIcon field="overheadsAmount" />
          </th>
          <th pSortableColumn="feeAmount" style="width: 8%">FEE <p-sortIcon field="feeAmount" /></th>
          <th pSortableColumn="rebateAmount" style="width: 8%">Rebate <p-sortIcon field="rebateAmount" /></th>
          <th pSortableColumn="suggestedPrice" style="width: 10%">Precio Sug. <p-sortIcon field="suggestedPrice" /></th>
          <th pSortableColumn="totalLinePrice" style="width: 10%">Total Línea <p-sortIcon field="totalLinePrice" /></th>
        </tr>
      </ng-template>
      <ng-template #body let-detail let-expanded="expanded">
        <tr>
          <td>
            <p-button type="button" [pRowToggler]="detail" [text]="true" [rounded]="true" [plain]="true"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
          </td>
          <td>{{ detail.module?.name }}</td>
          <td>{{ detail.quantity }}</td>
          <td>{{ detail.transportationCost | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.laborCost | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.packingCost | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.overheadsAmount | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.feeAmount | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.rebateAmount | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.suggestedPrice | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ detail.totalLinePrice | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
        </tr>
      </ng-template>
      <ng-template #expandedrow let-detail>
        <tr>
          <td colspan="11">
            <div class="p-3">
              <h6>Materiales del Módulo</h6>
              <p-table [value]="detail.subItems">
                <ng-template #header>
        <tr>
          <th pSortableColumn="material.name">Material <p-sortIcon field="material.name" /></th>
          <th pSortableColumn="quantity">Cantidad <p-sortIcon field="quantity" /></th>
          <th pSortableColumn="unitPrice">Precio Unit. <p-sortIcon field="unitPrice" /></th>
          <th pSortableColumn="totalPrice">Total <p-sortIcon field="totalPrice" /></th>
          <th pSortableColumn="pieces">Piezas <p-sortIcon field="pieces" /></th>
          <th pSortableColumn="rawMaterialCost">Costo MP <p-sortIcon field="rawMaterialCost" /></th>
        </tr>
      </ng-template>
      <ng-template #body let-subItem>
        <tr>
          <td>{{ subItem.material?.name }}</td>
          <td>{{ subItem.quantity }}</td>
          <td>{{ subItem.unitPrice | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ subItem.totalPrice | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
          <td>{{ subItem.pieces }}</td>
          <td>{{ subItem.rawMaterialCost | currency: 'PEN' : 'S/. ' : '1.2-2' }}</td>
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="6" class="text-center">No hay materiales</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  </td>
  </tr>
  </ng-template>
  </p-table>
</div>
</td>
</tr>
</ng-template>

<ng-template #emptymessage>
  <tr>
    <td colspan="7" class="text-center">No se encontraron cotizaciones</td>
  </tr>
</ng-template>
</p-table>
</div>

<!-- DIALOGO MASTER-DETAIL -->
<p-dialog [(visible)]="displayDialog" [header]="isEditMode ? 'Editar Cotización' : 'Nueva Cotización'" [modal]="true"
  [style]="{ width: '90vw', maxHeight: '90vh' }" [draggable]="false" [resizable]="false">
  <form [formGroup]="quotationForm">
    <div class="flex flex-column gap-3">

      <!-- Cliente y Vendedor -->
      <div class="formgrid grid">
        <div class="field col-6">
          <label htmlFor="customerDocumentNumber">Cliente *</label>
          <p-select id="customerDocumentNumber" formControlName="customerDocumentNumber" [options]="customers"
            optionLabel="companyName" optionValue="documentNumber" placeholder="Seleccione cliente" class="w-full"
            [filter]="true" />
          <small class="text-red-500"
            *ngIf="quotationForm.get('customerDocumentNumber')?.invalid && quotationForm.get('customerDocumentNumber')?.touched">
            El cliente es requerido
          </small>
        </div>

        <div class="field col-6">
          <label htmlFor="employeeDocumentNumber">Vendedor *</label>
          <p-select id="employeeDocumentNumber" formControlName="employeeDocumentNumber" [options]="employees"
            optionLabel="fullName" optionValue="documentNumber" placeholder="Seleccione vendedor" class="w-full"
            [filter]="true" />
          <small class="text-red-500"
            *ngIf="quotationForm.get('employeeDocumentNumber')?.invalid && quotationForm.get('employeeDocumentNumber')?.touched">
            El vendedor es requerido
          </small>
        </div>
      </div>

      <!-- DETAILS (Módulos) -->
      <div class="flex justify-content-between align-items-center">
        <h4>Módulos</h4>
        <p-button label="Agregar Módulo" icon="pi pi-plus" (onClick)="addDetail()" severity="secondary" size="small" />
      </div>

      <div formArrayName="details">
        <div *ngFor="let detail of details.controls; let i = index" [formGroupName]="i" class="card mb-3 p-3">
          <div class="flex justify-content-between align-items-center mb-2">
            <h5>Módulo #{{ i + 1 }}</h5>
            <p-button icon="pi pi-times" (onClick)="removeDetail(i)" severity="danger" [text]="true" [rounded]="true" />
          </div>

          <div class="formgrid grid">
            <div class="field col-4">
              <label>Módulo *</label>
              <p-select formControlName="moduleId" [options]="modules" optionLabel="name" optionValue="id"
                placeholder="Seleccione" class="w-full" />
            </div>
            <div class="field col-2">
              <label>Cantidad *</label>
              <p-inputNumber formControlName="quantity" [min]="1" class="w-full" />
            </div>
            <div class="field col-2">
              <label>Transporte</label>
              <p-inputNumber formControlName="transportationCost" mode="currency" currency="USD" [minFractionDigits]="2"
                class="w-full" />
            </div>
            <div class="field col-2">
              <label>M. Obra</label>
              <p-inputNumber formControlName="laborCost" mode="currency" currency="USD" [minFractionDigits]="2"
                class="w-full" />
            </div>
            <div class="field col-2">
              <label>Empaque</label>
              <p-inputNumber formControlName="packingCost" mode="currency" currency="USD" [minFractionDigits]="2"
                class="w-full" />
            </div>
          </div>

          <!-- SUBITEMS (Materiales) -->
          <div class="flex justify-content-between align-items-center mt-3 mb-2">
            <h6>Materiales del Módulo</h6>
            <p-button label="Agregar Material" icon="pi pi-plus" (onClick)="addSubItem(i)" size="small" />
          </div>

          <div formArrayName="subItems">
            <div *ngFor="let subItem of getSubItems(i).controls; let j = index" [formGroupName]="j"
              class="formgrid grid align-items-end mb-2">
              <div class="field col-3">
                <label>Material *</label>
                <p-select formControlName="materialId" [options]="materials" optionLabel="name" optionValue="id"
                  placeholder="Seleccione" class="w-full" [filter]="true" />
              </div>
              <div class="field col-2">
                <label>Cantidad *</label>
                <p-inputNumber formControlName="quantity" [minFractionDigits]="2" [maxFractionDigits]="4" [min]="0.0001" class="w-full" />
              </div>
              <div class="field col-3">
                <label>Costo MP *</label>
                <p-inputNumber formControlName="rawMaterialCost" mode="currency" currency="USD" [minFractionDigits]="2"
                  class="w-full" />
              </div>
              <div class="field col-2">
                <label>Piezas</label>
                <p-inputNumber formControlName="pieces" class="w-full" />
              </div>
              <div class="field col-2">
                <p-button icon="pi pi-trash" (onClick)="removeSubItem(i, j)" severity="danger" [text]="true" />
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="flex justify-content-end gap-2 mt-4">
      <p-button label="Cancelar" severity="secondary" (onClick)="hideDialog()" type="button" />
      <p-button label="Guardar" (onClick)="saveQuotation()" [disabled]="quotationForm.invalid" />
    </div>
  </form>
</p-dialog>
</div>

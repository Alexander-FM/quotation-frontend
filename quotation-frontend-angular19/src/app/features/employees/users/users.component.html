<div class="p-4">
  <p-toast />
  <p-confirmDialog />

  <div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Gesti√≥n de Usuarios</h2>
      <p-button label="Nuevo Usuario" icon="pi pi-plus" (onClick)="openNew()" severity="success" />
    </div>

    <p-table [value]="users" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,25,50]" [loading]="loading"
      [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
      [tableStyle]="{ 'min-width': '60rem' }">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 8%">ID</th>
          <th style="width: 20%">Username</th>
          <th style="width: 30%">Roles</th>
          <th style="width: 12%">Estado</th>
          <th style="width: 15%">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>{{ user.id }}</td>
          <td>{{ user.username }}</td>
          <td>
            <div class="flex flex-wrap gap-2">
              <p-tag *ngFor="let r of user.roles" [value]="r.roleName" severity="info" />
            </div>
          </td>
          <td>
            <p-tag [value]="user.isActive ? 'Activo' : 'Inactivo'" [severity]="user.isActive ? 'success' : 'danger'" />
          </td>
          <td>
            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editUser(user)" class="mr-2" />
            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="deleteUser(user)" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">No se encontraron usuarios</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog [(visible)]="displayDialog" [header]="isEditMode ? 'Editar Usuario' : 'Nuevo Usuario'" [modal]="true"
    [style]="{ width: '600px' }" [draggable]="false" [resizable]="false">
    <form [formGroup]="userForm">
      <div class="flex flex-column gap-3">
        <div class="flex flex-column gap-2">
          <label htmlFor="username">Username *</label>
          <input pInputText id="username" formControlName="username" placeholder="Ingrese el username" />
          <small class="text-red-500" *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
            El username es requerido
          </small>
        </div>

        <div class="flex flex-column gap-2">
          <label htmlFor="password">Password *</label>
          <input pInputText type="password" id="password" formControlName="password" placeholder="Ingrese el password" />
          <small class="text-red-500" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            El password es requerido
          </small>
        </div>

        <div class="flex flex-column gap-2">
          <label htmlFor="roles">Roles *</label>
          <p-multiselect
            id="roles"
            formControlName="roles"
            [options]="roles"
            optionLabel="roleName"
            display="chip"
            appendTo="body"
            panelStyleClass="roles-panel"
            placeholder="Seleccione roles"
            class="w-full" />
          <small class="text-red-500" *ngIf="userForm.get('roles')?.invalid && userForm.get('roles')?.touched">
            Debe seleccionar al menos un rol
          </small>
        </div>

        <div class="flex align-items-center gap-2">
          <p-checkbox formControlName="isActive" [binary]="true" inputId="isActive" />
          <label htmlFor="isActive">Activo</label>
        </div>
      </div>

      <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Cancelar" severity="secondary" (onClick)="hideDialog()" type="button" />
        <p-button
          label="Guardar"
          (onClick)="saveUser()"
          [disabled]="userForm.invalid || (userForm.get('roles')?.value?.length || 0) === 0" />
      </div>
    </form>
  </p-dialog>
</div>
